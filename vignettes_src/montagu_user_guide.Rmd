---
title: "Montagu API from R"
author: "VIMC Technical Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Montagu API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette, we describe a typical example of building
a model in R, which uses the demography and templates available
through the Montagu API, and submited burden estimates to it. We
will proceed very naively and cover all of the important
functionality on the way.

### Identify the Montagu Server

Begin by identifying the Montagu server to connect to. You must
have an account on this server; typically this will be our live
production server, and you will have received login information
on joining VIMC. Identify the server as follows:-

```r
montagu::montagu_server_global_default_set(
  montagu::montagu_server("production", "montagu.vaccineimpact.org"))
```

```{r, include = FALSE}
knitr::opts_chunk$set(error = FALSE)
options(montagu.username = "test.user@imperial.ac.uk",
        montagu.password = "password")
montagu::montagu_server_global_default_set(
  montagu::montagu_server("uat", "support.montagu.dide.ic.ac.uk", 10443))
montagu::montagu_diseases()
```

The next time you query the server, you may be asked to
login with a username and password.

### Basic Information

For many of the montagu api functions, you will need to provide your
modelling group id, and your disease id. These will have been communicated on
joining VIMC, but can be looked up with simple function calls like this:-

```{r}
montagu::montagu_diseases()
```

```{r}
groups <- montagu::montagu_modelling_groups()
head(groups)
```

### Touchstones

A touchstone is an identifier that links:

* A request from VIMC to the modelling groups to provide burden estimates
* The input data (coverage and demography) provided to calculate those estimates
* The estimates submitted by the groups using the input data.

Touchstone ids are referred to as a basename and a version together. Errata
to the input data may be addressed with a new touchstone version. Generally,
modelling groups will know which touchstone they are required to run models
against. To lookup all the currently open touchstones for a group:-

```{r}
montagu::montagu_touchstone_versions("IC-Garske", require_open = TRUE)
```

If we knew the basic touchstone name (without version) that we were interested in,
then we could also have asked:
```{r}
montagu::montagu_touchstone_versions("IC-Garske", "201710gavi", require_open = TRUE)
```

### Scenarios

Within a touchstone, we may have various scenarios, describing different
vaccination conditions. These vary across diseases due to the different types
of vaccination approaches that have been employed. We look our the scenarios
we are required to model for a touchstone with:

```{r}
montagu::montagu_scenarios("IC-Garske", "201710gavi-5")
```

We can then look up the status a particular scenario within this touchstone:

```{r}
montagu::montagu_scenario_status("IC-Garske", "201710gavi-5", "yf-routine-gavi")
```

and if that status were not valid, then we can query any problems with:
```{r}
montagu::montagu_scenario_problems("IC-Garske", "201710gavi-5", "yf-routine-gavi")

```

### Expectations - years, ages, countries and outcomes

For a given touchstone, modelling groups are required to produce burden estimates
stratified by calendar year, and by age. The expectations about time and age
will be consistent across scenarios. We can look up these expectations like so:

```{r}
montagu::montagu_expectations("IC-Garske", "201710gavi-5")
```

Some modelling groups model more than one disease, in which case a row appears
for each disease. And additionally, if there is some reason to have different
expectations for different scenarios, then multiple lines for the same disease
may appear, with a difference in the description column indicating the scenario.
For example:
```{r}
montagu::montagu_expectations("CDA-Razavi", "201710gavi-5")
```

If we already knew the expectation id, we could look up
a single expectation with

```{r}
montagu::montagu_expectation("IC-Garske", "201710gavi-5", 30)
```

The countries for which estimates are required can vary between disease, and
between scenarios. To retrieve the list of countries that are required for a
particular expectation:-

```{r}
countries <- montagu::montagu_expectation_countries("IC-Garske", "201710gavi-5", 30)
head(countries)
```

To see which outcomes are required for an expectation:
```{r}
montagu::montagu_expectation_outcomes("IC-Garske", "201710gavi-5", 30)
```

And to confirm which scnearios an expectation applies to (which should align
with the description text for the expectation):
```{r}
montagu::montagu_expectation_applicable_scenarios("IC-Garske", "201710gavi-5", 30)
montagu::montagu_expectation_applicable_scenarios("CDA-Razavi", "201710gavi-5", 2)
```

### Templates

The above will give all the information required to build your own data frame
for submitting the expected results. Alternatively, you can download
burden estimate templates with the years, countries and ages already populated:-

```{r}
df <- montagu::montagu_central_burden_estimate_template("IC-Garske", "201710gavi-5", 30)
head(df)
```

### Coverage

We now need to obtain the coverage data relevant for our disease and touchstone,
for each of the scenarios we're going to model. Let's look at the `yf-routine-gavi` 
coverage metadata.

```{r}
montagu::montagu_coverage_info("IC-Garske", "201710gavi-5", "yf-routine-gavi")
```

And now let's retrieve the coverage data itself, and summarise it.

```{r}
cov <- montagu::montagu_coverage_data("IC-Garske", "201710gavi-5", "yf-routine-gavi")
head(cov[cov$coverage > 0, ])
range(cov$year)
length(unique(cov$country_code))
nrow(cov)
ncol(cov)

```
More information on the coverage is available in the Montagu Web Portal, but briefly:

* _Coverage_ is measured as a proportion of the original target population. It is possible
for this to exceed 1, if more people were vaccinated than originally targeted.
* _Target_ is the number of individuals targeted for vaccination. If this is `NA`, then
assume the target population matches the demographic data, and the whole population is targeted.

#### Long or Wide format

The data above is formatted in what we call `long format`, in which one year is reported per row. 
Alternatively, you can specify:
```{r}
cov <- montagu::montagu_coverage_data("IC-Garske", "201710gavi-5", "yf-routine-gavi", format="wide")
names(cov)[1:20]
nrow(cov)
ncol(cov)
```
Here, we have one row per country, and separate columns for `coverage_year` and `target_year`.

#### Returning the full range of countries

By default, the coverage data returned is limited to those countries for which burden
estimate data is required for the given scenario. HepB is a particular example, where different
sets of countries are relevant in different scenarios, because the birth-dose vaccination
is not applied in all countries where there is HepB vaccination. However, some groups prefer
to model all of these scenarios similarly, with the same numbers of countries, hence they require 
the full coverage data for all countries. And for some diseases, the historic effects of vaccination 
in a country that is not required for estimates as present, may have relevance in their model to 
countries that are required. 

For those cases, where all countries are required, the `all_countries` optional argument can be used:

```{r}
cov_all <- montagu::montagu_coverage_data("CDA-Razavi", "201710gavi-5", "hepb-bd-routine-with", all_countries = TRUE)
cov_not <- montagu::montagu_coverage_data("CDA-Razavi", "201710gavi-5", "hepb-bd-routine-with", all_countries = FALSE)
length(unique(cov_all$country))
length(unique(cov_not$country))
```

## Stochastic Runs

In order to establish confidence intervals, modelling groups are sometimes asked to run a stochastic 
ensemble of models. This may be, for instance, 200 instances of a model, with different parameters
for each instance. We would call the instance number, between 1 and 200, the `run_id`, and there
would be a unique set of parameters for each. 

It is important that for a given `run_id`, all the
relevant scenarios are run with the matching set of parameters for that `run_id`, so that we can 
compare scenarios and calculate impacts. 

It is also important that the spread of parameters chosen across the 200 runs significantly captures
the range of sensible behaviour of the model, and that the central estimates submitted are somewhere
near the centre of the spread of parameters.  

Lastly, it is desirable to vary as few parameters as possible, so that with 200 runs, we can see
how the parameter changes affect the model outcomes. If there are too many parameters, it may be
difficult to ascertain which parameters are causing the changes, or whether the spread of 
parameters really does capture the significant behaviour of the model.

### Model Run Parameter Sets

The model run parameter set has a column for `run_id`, and another column for each parameter
being varied. For example:

```{r}
params <- data.frame(run_id = 1:5, param_1 = sample(5), param_2 = sample(5))
params
```

This can then be uploaded as follows:-

```r
id <- montagu::montagu_model_run_parameter_set_upload(
    "IC-Garske", "201710gavi-5", "YF", params)
```

and the id of the newly created parameter set will be returned. For stochastic data, we will
need to supply this id when creating the associated burden estimate set.

#TODO - add burden estimate set example here in i2625

We can also list the existing model run parameter sets with:-

```{r}
head(montagu::montagu_model_run_parameter_sets("IC-Garske", "201710gavi-5"))
```

or for a list of information about a single parameter set:

```{r}
montagu::montagu_model_run_parameter_set_info("IC-Garske", "201710gavi-5", 20)
```

Finally, if we want to retrieve the parameter values for a previous set:-

```{r}
data <- montagu::montagu_model_run_parameter_set_data("IC-Garske", "201710gavi-5", 20)
data[1:5,1:5]
```

## Appendix

### Models

Montagu allows querying of basic information about all models, past and present
used in VIMC. These can be listed as follows:-

```{r}
models <- montagu::montagu_models()
head(models)
```

and a list of information about a particular model by its id can be retrieved
like this:-

```{r}
montagu::montagu_model("YFIC")
```

Note that the model_id (id column above) is different from the modelling_group_id, 
and generally the modelling_group_id is the significant identifier required
for other Montagu functions.
