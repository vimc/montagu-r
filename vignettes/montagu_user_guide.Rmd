---
title: "Montagu API from R"
author: "VIMC Technical Team"
date: "2019-03-04"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Montagu API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette, we describe a typical example of building
a model in R, which uses the demography and templates available
through the Montagu API, and submited burden estimates to it. We
will proceed very naively and cover all of the important
functionality on the way.

### Identify the Montagu Server

Begin by identifying the Montagu server to connect to. You must
have an account on this server; typically this will be our live
production server, and you will have received login information
on joining VIMC. Identify the server as follows:-

```r
montagu::montagu_server_global_default_set(
  montagu::montagu_server("production", "montagu.vaccineimpact.org"))
```



The next time you query the server, you may be asked to
login with a username and password.

### Basic Information

For many of the montagu api functions, you will need to provide your
modelling group id, and your disease id. These will have been communicated on
joining VIMC, but can be looked up with simple function calls like this:-


```r
montagu::montagu_diseases()
```

```
##         id                         name
## 1     HepB                         HepB
## 2      Hib                          Hib
## 3      HPV                          HPV
## 4       JE                           JE
## 5  Measles                      Measles
## 6     MenA                         MenA
## 7      PCV                          PCV
## 8     Rota                    Rotavirus
## 9  Rubella                      Rubella
## 10      YF                 Yellow fever
## 11     DTP Diphtheria Tetanus Pertussis
```


#TODO - enable below after i2557
```r
groups <- montagu::montagu_modelling_groups()
head(groups)
```

### Touchstones

A touchstone is an identifier that links:

* A request from VIMC to the modelling groups to provide burden estimates
* The input data (coverage and demography) provided to calculate those estimates
* The estimates submitted by the groups using the input data.

Touchstone ids are referred to as a basename and a version together. Errata
to the input data may be addressed with a new touchstone version. Generally,
modelling groups will know which touchstone they are required to run models
against. To lookup all the currently open touchstones for a group:-


```r
montagu::montagu_touchstone_versions("IC-Garske", require_open = TRUE)
```

```
##                  id            name version                 description
## 6      201710gavi-5      201710gavi       5      201710gavi (version 5)
## 7 201810synthetic-2 201810synthetic       2 201810synthetic (version 2)
##   status
## 6   open
## 7   open
```

If we knew the basic touchstone name (without version) that we were interested in,
then we could also have asked:

```r
montagu::montagu_touchstone_versions("IC-Garske", "201710gavi", require_open = TRUE)
```

```
##             id       name version            description status
## 1 201710gavi-5 201710gavi       5 201710gavi (version 5)   open
```

### Scenarios

Within a touchstone, we may have various scenarios, describing different
vaccination conditions. These vary across diseases due to the different types
of vaccination approaches that have been employed. We look our the scenarios
we are required to model for a touchstone with:


```r
montagu::montagu_scenarios("IC-Garske", "201710gavi-5")
```

```
##          scenario_id                  description disease
## 1  yf-no-vaccination               No vaccination      YF
## 2    yf-routine-gavi               Routine, total      YF
## 3 yf-preventive-gavi Campaign (preventive), total      YF
```

We can then look up the status a particular scenario within this touchstone:


```r
montagu::montagu_scenario_status("IC-Garske", "201710gavi-5", "yf-routine-gavi")
```

```
## [1] "valid"
```

and if that status were not valid, then we can query any problems with:

```r
montagu::montagu_scenario_problems("IC-Garske", "201710gavi-5", "yf-routine-gavi")
```

```
## list()
```

### Expectations - years, ages, countries and outcomes

For a given touchstone, modelling groups are required to produce burden estimates
stratified by calendar year, and by age. The expectations about time and age
will be consistent across scenarios. We can look up these expectations like so:


```r
montagu::montagu_expectations("IC-Garske", "201710gavi-5")
```

```
##   id           description min_year max_year min_age max_age
## 1 30 YF:IC-Garske:standard     2000     2100       0     100
##   min_birth_cohort max_birth_cohort disease
## 1             1900             2100      YF
```

Some modelling groups model more than one disease, in which case a row appears
for each disease. And additionally, if there is some reason to have different
expectations for different scenarios, then multiple lines for the same disease
may appear, with a difference in the description column indicating the scenario.
For example:

```r
montagu::montagu_expectations("CDA-Razavi", "201710gavi-5")
```

```
##   id                                            description min_year
## 1  2                   HepB:CDA-Razavi:hepb-bd-routine-with     2000
## 2  4 HepB:CDA-Razavi:hepb-bd-routine-with-hepb-routine-with     2000
## 3  3                 HepB:CDA-Razavi:hepb-hepb-routine-with     2000
## 4  1                    HepB:CDA-Razavi:hepb-no-vaccination     2000
## 5  5 HepB:CDA-Razavi:hepb-bd-routine-best-hepb-routine-with     2000
##   max_year min_age max_age min_birth_cohort max_birth_cohort disease
## 1     2100       0      85             1915             2100    HepB
## 2     2100       0      85             1915             2100    HepB
## 3     2100       0      85             1915             2100    HepB
## 4     2100       0      85             1915             2100    HepB
## 5     2100       0      85             1915             2100    HepB
```

If we already knew the expectation id, we could look up
a single expectation with


```r
montagu::montagu_expectation("IC-Garske", "201710gavi-5", 30)
```

```
## $id
## [1] 30
##
## $description
## [1] "YF:IC-Garske:standard"
##
## $min_year
## [1] 2000
##
## $max_year
## [1] 2100
##
## $min_age
## [1] 0
##
## $max_age
## [1] 100
##
## $min_birth_cohort
## [1] 1900
##
## $max_birth_cohort
## [1] 2100
##
## $disease
## NULL
```

The countries for which estimates are required can vary between disease, and
between scenarios. To retrieve the list of countries that are required for a
particular expectation:-


```r
countries <- montagu::montagu_expectation_countries("IC-Garske", "201710gavi-5", 30)
head(countries)
```

```
##    id                     name
## 1 AGO                   Angola
## 2 BDI                  Burundi
## 3 BEN                    Benin
## 4 BFA             Burkina Faso
## 5 CAF Central African Republic
## 6 CIV            Cote d'Ivoire
```

To see which outcomes are required for an expectation:

```r
montagu::montagu_expectation_outcomes("IC-Garske", "201710gavi-5", 30)
```

```
## [1] "deaths" "cases"  "dalys"
```

And to confirm which scnearios an expectation applies to (which should align
with the description text for the expectation):

```r
montagu::montagu_expectation_applicable_scenarios("IC-Garske", "201710gavi-5", 30)
```

```
## [1] "yf-no-vaccination"  "yf-preventive-gavi" "yf-routine-gavi"
```

```r
montagu::montagu_expectation_applicable_scenarios("CDA-Razavi", "201710gavi-5", 2)
```

```
## [1] "hepb-bd-routine-with"
```

### Templates

The above will give all the information required to build your own data frame
for submitting the expected results. Alternatively, you can download
burden estimate templates with the years, countries and ages already populated:-


```r
df <- montagu::montagu_central_burden_estimate_template("IC-Garske", "201710gavi-5", 30)
head(df)
```

```
##   disease year age country country_name cohort_size deaths cases dalys
## 1      YF 2000   0     AGO       Angola          NA     NA    NA    NA
## 2      YF 2001   0     AGO       Angola          NA     NA    NA    NA
## 3      YF 2002   0     AGO       Angola          NA     NA    NA    NA
## 4      YF 2003   0     AGO       Angola          NA     NA    NA    NA
## 5      YF 2004   0     AGO       Angola          NA     NA    NA    NA
## 6      YF 2005   0     AGO       Angola          NA     NA    NA    NA
```

### Coverage

We now need to obtain the coverage data relevant for our disease and touchstone,
for each of the scenarios we're going to model. Let's look at the `yf-routine-gavi`
coverage metadata.

#TODO: Enable below after i2567
```r
montagu::montagu_coverage_info("IC-Garske", "201710gavi-5", "yf-routine-gavi")
```

And now let's retrieve the coverage data itself, and summarise it.

#TODO: Enable below after i2567
```r
cov <- montagu::montagu_coverage_data("IC-Garske", "201710gavi-5", "yf-routine-gavi")
head(cov[cov$coverage > 0, ])
range(cov$year)
length(unique(cov$country_code))
nrow(cov)
ncol(cov)

```
More information on the coverage is available in the Montagu Web Portal, but briefly:

* _Coverage_ is measured as a proportion of the original target population. It is possible
for this to exceed 1, if more people were vaccinated than originally targeted.
* _Target_ is the number of individuals targeted for vaccination. If this is `NA`, then
assume the target population matches the demographic data, and the whole population is targeted.

#### Long or Wide format

The data above is formatted in what we call `long format`, in which one year is reported per row.
Alternatively, you can specify:
#TODO: Enable below after i2567
```r
cov <- montagu::montagu_coverage_data("IC-Garske", "201710gavi-5", "yf-routine-gavi", format="wide")
names(cov)[1:20]
nrow(cov)
ncol(cov)
```
Here, we have one row per country, and separate columns for `coverage_year` and `target_year`.

#### Returning the full range of countries

By default, the coverage data returned is limited to those countries for which burden
estimate data is required for the given scenario. HepB is a particular example, where different
sets of countries are relevant in different scenarios, because the birth-dose vaccination
is not applied in all countries where there is HepB vaccination. However, some groups prefer
to model all of these scenarios similarly, with the same numbers of countries, hence they require
the full coverage data for all countries. And for some diseases, the historic effects of vaccination
in a country that is not required for estimates as present, may have relevance in their model to
countries that are required.

For those cases, where all countries are required, the following optional argument can be used:

#TODO: Enable below after i2567
```r
cov <- montagu::montagu_coverage_data("IC-Garske", "201710gavi-5", "yf-routine-gavi", all_countries = TRUE)
```

## Burden Estimate Sets

The burden estimate set defines the results of the models, which modelling groups submit back to Montagu.
To view the burden estimate sets already uploaded, for a group, touchstone and scenario:-


```r
head(montagu::montagu_burden_estimate_sets("IC-Garske", "201710gavi-5", "yf-no-vaccination"))
```

```
##       id              uploaded_on    uploaded_by               type
## 37   687 2018-04-06T13:08:18.883Z katy.gaythorpe   central-averaged
## 100  698 2018-05-30T09:27:32.341Z    tini.garske central-single-run
## 1   1049 2019-02-15T11:48:00.515Z      test.user   central-averaged
## 2   1050 2019-02-15T12:16:44.479Z      test.user         stochastic
## 4   1051 2019-02-15T12:49:19.553Z      test.user   central-averaged
## 5   1052 2019-02-15T15:36:46.370Z      test.user   central-averaged
##                                                                  details
## 37  Averaged over posterior predictive distribution for model parameters
## 100                                                                    x
## 1                                          Mean over all stochastic runs
## 2                                                                Details
## 4                                                                Details
## 5                                                                Details
##       status
## 37  complete
## 100    empty
## 1      empty
## 2      empty
## 4    invalid
## 5    invalid
```

If we know the burden estimate set id, we can also get a list of information about a burden estimate set with:


```r
montagu::montagu_burden_estimate_set_info("IC-Garske", "201710gavi-5", "yf-no-vaccination", 687)
```

```
## $id
## [1] 687
##
## $uploaded_on
## [1] "2018-04-06T13:08:18.883Z"
##
## $uploaded_by
## [1] "katy.gaythorpe"
##
## $type
## [1] "central-averaged"
##
## $details
## [1] "Averaged over posterior predictive distribution for model parameters"
##
## $status
## [1] "complete"
```

If there are any reported problems with a burden estimate set, we can examine those with


```r
montagu::montagu_burden_estimate_set_problems("IC-Garske", "201710gavi-5", "yf-no-vaccination", 687)
```

```
## list()
```

and we can retrieve the data for the burden estimate set with:


```r
data <- montagu::montagu_burden_estimate_set_data("IC-Garske", "201710gavi-5", "yf-no-vaccination", 687)
head(data)
```

```
##   disease year age country             country_name cohort_size
## 1      YF 2000   0     AGO                   Angola      700752
## 2      YF 2000   0     BDI                  Burundi      240741
## 3      YF 2000   0     BEN                    Benin      262535
## 4      YF 2000   0     BFA             Burkina Faso      479329
## 5      YF 2000   0     CAF Central African Republic      134101
## 6      YF 2000   0     CIV            Cote d'Ivoire      621898
##         cases        dalys       deaths
## 1  318.439060   8546.53100  149.6663700
## 2    1.367271     36.17757    0.6426176
## 3  391.006130  10355.80300  183.7728900
## 4  886.209960  22402.71700  416.5186800
## 5  131.855550   3089.01600   61.9721070
## 6 4620.652300 106431.76000 2171.7068000
```

### Creating a new burden estimate set

A new burden estimate set can be created as follows:-

```r
bsid <- montagu::montagu_burden_estimate_set_create(
    "IC-Garske", "201710gavi-5", "yf-no-vaccination", "central-averaged",
    model_run_parameter_set = NULL, details = "Details about model")
```

For central estimates, the `model_run_parameter_set` can be ignored, or set to NULL as shown here,
but it should not have a non-null value. For stochastic estimates, it must be set to a valid
model run parameter set - see the section below on stochastic runs.

The result of the burden estimate set creation is the id of the newly created burden estimate set.

### Adding data

### Clearing

### Closing

### Plotting previous burden estimate sets

One further function call useful for plotting, allows retrieving a particular burden outcome
from a burden estimate set, summed across all countries, and dis-aggregated by either age or by year.
The result will be a sequence of sets of (x,y) points, suitable for straightforward plotting. For
example:


```r
data <- montagu::montagu_burden_estimate_set_outcome_data("IC-Garske", "201710gavi-5",
         "yf-no-vaccination", 687, "cases", group_by = "age")
head(data)
```

```
##   age    x        y
## 1   0 2000 21955.19
## 2   0 2001 22429.77
## 3   0 2002 22904.21
## 4   0 2003 23388.83
## 5   0 2004 23899.00
## 6   0 2005 24444.64
```

```r
plot(data$x[data$age==20], data$y[data$age==20], xlab="year", ylab="cases", main="For age 20")
```

![plot of chunk unnamed-chunk-19](figure/montagu_user_guide-unnamed-chunk-19-1.png)

Or to dis-aggregate by year:-


```r
data <- montagu::montagu_burden_estimate_set_outcome_data("IC-Garske", "201710gavi-5",
         "yf-no-vaccination", 687, "cases", group_by = "year")
head(data)
```

```
##       year x        y
## 20001 2000 0 21955.19
## 20002 2000 1 20183.78
## 20003 2000 2 18625.01
## 20004 2000 3 17217.85
## 20005 2000 4 15857.58
## 20006 2000 5 14775.94
```

```r
plot(data$x[data$year==2040], data$y[data$year==2040], xlab="age", ylab="cases", main="For year 2040")
```

![plot of chunk unnamed-chunk-20](figure/montagu_user_guide-unnamed-chunk-20-1.png)

## Stochastic Runs

In order to establish confidence intervals, modelling groups are sometimes asked to run a stochastic
ensemble of models. This may be, for instance, 200 instances of a model, with different parameters
for each instance. We would call the instance number, between 1 and 200, the `run_id`, and there
would be a unique set of parameters for each.

It is important that for a given `run_id`, all the
relevant scenarios are run with the matching set of parameters for that `run_id`, so that we can
compare scenarios and calculate impacts.

It is also important that the spread of parameters chosen across the 200 runs significantly captures
the range of sensible behaviour of the model, and that the central estimates submitted are somewhere
near the centre of the spread of parameters.

Lastly, it is desirable to vary as few parameters as possible, so that with 200 runs, we can see
how the parameter changes affect the model outcomes. If there are too many parameters, it may be
difficult to ascertain which parameters are causing the changes, or whether the spread of
parameters really does capture the significant behaviour of the model.

### Model Run Parameter Sets

The model run parameter set has a column for `run_id`, and another column for each parameter
being varied. For example:


```r
params <- data.frame(run_id = 1:5, param_1 = sample(5), param_2 = sample(5))
params
```

```
##   run_id param_1 param_2
## 1      1       1       1
## 2      2       3       2
## 3      3       5       3
## 4      4       4       4
## 5      5       2       5
```

This can then be uploaded as follows:-

```r
id <- montagu::montagu_model_run_parameter_set_upload(
    "IC-Garske", "201710gavi-5", "YF", params)
```

and the id of the newly created parameter set will be returned. For stochastic data, we will
need to supply this id when creating the associated burden estimate set.

#TODO - add burden estimate set example here in i2625

We can also list the existing model run parameter sets with:-

#TODO - uncomment after i2634
```r
head(montagu::montagu_model_run_parameter_sets("IC-Garske", "201710gavi-5"))
```

or for a list of information about a single parameter set:

#TODO - uncomment after i2634
```r
montagu::montagu_model_run_parameter_set_info("IC-Garske", "201710gavi-5", 20)
```

Finally, if we want to retrieve the parameter values for a previous set:-

#TODO - uncomment after i2634
```r
data <- montagu::montagu_model_run_parameter_set_data("IC-Garske", "201710gavi-5", 20)
data[1:5,1:5]
```


## Appendix

### Models

Montagu allows querying of basic information about all models, past and present
used in VIMC. These can be listed as follows:-


```r
models <- montagu::montagu_models()
head(models)
```

```
##                 id
## 1         Yakob-YF
## 2   Winter-Rubella
## 3        UnknownYF
## 4   HPVGoldie-flat
## 5 HPVGoldie-linear
## 6        PATH-MenA
##                                                                                                                                                                                                                                                                                                                                                                              description
## 1                                                                                                                                                                                                                                                                                                                                generic 201810rfp model - to be updated if joining VIMC
## 2                                                                                                                                                                                                                                                                                                                                generic 201810rfp model - to be updated if joining VIMC
## 3                                                                                                                                                                                                                                                                                                                                          Yellow fever data imported from the shiny app
## 4 Used in SDF8 input as flat ages. The model is constructed as a static cohort simulation model based on a structure similar to a simple decision tree, and is programmed using Microsoft Excel and Visual Basic for Applications. The model tracks a cohort of girls at a target age for their lifetimes, comparing health and cost outcomes with and without HPV vaccination programs.
## 5    Used in SDF8 as linear ages.  The model is constructed as a static cohort simulation model based on a structure similar to a simple decision tree, and is programmed using Microsoft Excel and Visual Basic for Applications. The model tracks a cohort of girls at a target age for their lifetimes, comparing health and cost outcomes with and without HPV vaccination programs.
## 6                                                                                                                                              MenA model used in SDF8 and SDF12. A static population-based cohort model developed to support the 2008 WHO and UNICEF investment case 'Eliminating serogroup A meningococcal meningitis epidemics as a public health problem in Africa.'
##                                  citation modelling_group
## 1                <citation for the model>     LSHTM-Yakob
## 2                <citation for the model>       PU-Winter
## 3 https://github.com/royburst/Gavi-Impact         unknown
## 4                <citation for the model>   Harvard-Sweet
## 5                <citation for the model>   Harvard-Sweet
## 6                <citation for the model>    Suraratdecha
```

and a list of information about a particular model by its id can be retrieved
like this:-


```r
montagu::montagu_model("YFIC")
```

```
## $id
## [1] "YFIC"
##
## $description
## [1] "YF model developed at Imperial College London, used in SDF8 and SDF12. This is a generalised linear regression model fitted to locations of reported yellow fever outbreaks or cases with anthropogenic and environmental covariates generating a risk map for yellow fever across Africa. It was then compared to the available serological data, primarily from central and eastern Africa, to assess the country-specific scale of under-reporting and obtain absolute estimates of transmission intensity in terms of a static force of infection or a basic reproduction number in a dynamical model, taking into account the population-level vaccination coverage through time. Burden and vaccine impact estimates were then generated by combining the transmission intensity with demographic information (population size and age distribution) and observed and hypothetical vaccination coverages in any given location and year."
##
## $citation
## [1] "10.1371/journal.pmed.1001638"
##
## $modelling_group
## [1] "IC-Garske"
```

Note that the model_id (id column above) is different from the modelling_group_id,
and generally the modelling_group_id is the significant identifier required
for other Montagu functions.
